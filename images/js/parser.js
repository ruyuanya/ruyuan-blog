function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _createForOfIteratorHelper(e,t){var r,i,a,n,o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(o)return a=!(i=!0),{s:function(){o=o.call(e)},n:function(){var e=o.next();return i=e.done,e},e:function(e){a=!0,r=e},f:function(){try{i||null==o.return||o.return()}finally{if(a)throw r}}};if(Array.isArray(e)||(o=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return o&&(e=o),n=0,{s:t=function(){},n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var r;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=Array(t);r<t;r++)i[r]=e[r];return i}function ownKeys(t,e){var r,i=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)),i}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==_typeof(e)?e:e+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Parser=void 0,exports.parse=parse,exports.getGroupImageUrl=getGroupImageUrl;var zlib_1=require("zlib"),core_1=require("../core"),face_1=require("./face"),image_1=require("./image");function parse(e,t){return new Parser(e,t)}var Parser=(()=>_createClass(function e(t,r){_classCallCheck(this,e),this.uin=r,this.message=[],this.brief="",this.content="",this.atme=!1,this.atall=!1,this.newImg=!1,this.imgprefix={},this.exclusive=!1,Array.isArray(t)?this.parseElems(t):(t[4]&&t[4].length&&this.parseExclusiveElem(0,t[4]),this.parseElems(Array.isArray(t[2])?t[2]:[t[2]]))},[{key:"getNextText",value:function(){try{var e,t=null==(e=this.it)?void 0:e.next().value[1][1];return String(t[1])}catch(e){return"[未知]"}}},{key:"parseExclusiveElem",value:function(e,t){switch(e){case 12:case 51:var r,i=t[1].toBuffer(),a=(r={type:12===e?"xml":"json",data:String(0<i[0]?(0,zlib_1.unzipSync)(i.slice(1)):i.slice(1)),id:t[2]}).type+"消息";this.content=r.data;break;case 3:r=this.parseNewImgElem(t,"flash"),a="闪照",this.content="{flash:".concat(r.file.slice(0,32).toUpperCase(),"}");break;case 0:r={type:"record",file:"protobuf://"+t.toBase64(),url:"",md5:t[4].toHex(),size:t[6]||0,seconds:t[19]||0},t[20]&&(i=String(t[20]),r.url=i.startsWith("http")?i:"https://grouptalk.c2c.qq.com"+i),a="语音",this.content="{ptt:".concat(r.url,"}");break;case 19:r={type:"video",file:"protobuf://"+t.toBase64(),name:(null==(i=t[3])?void 0:i.toString())||"",fid:String(t[1]),md5:t[2].toBase64(),size:t[6]||0,seconds:t[5]||0},a="视频",this.content="{video:".concat(r.fid,"}");break;case 5:i=core_1.pb.decode(t[2].toBuffer().slice(3))[7][2];r={type:"file",name:String(i[4]),fid:String(i[2]).replace("/",""),md5:String(i[8]),size:i[3],duration:i[5]},a="群文件",this.content="{file:".concat(r.fid,"}");break;case 37:(r={type:"face",id:t[2][3],text:t[2][7]?String(t[2][7]):"超级表情",big:!0}).text||(r.text=t[2][7]?String(t[2][7]):"超级表情"),t[2][2]&&(r.stickerId=String(t[2][2]),r.stickerType=t[2][5]),a=r.text,this.content="{face:".concat(r.id,",text:").concat(r.text,"}");break;case 126:if(!t[3])return;i=126===t[3]?t[2][4]:t[3];r={type:"poke",id:i,text:face_1.pokemap[i]},a=face_1.pokemap[i],this.content="{poke:".concat(r.id,"}");break;default:return}this.message=[r],this.brief="["+a+"]"}},{key:"parsePartialElem",value:function(e,t){var r="",i="";switch(e){case 1:var r=String(t[1]),a=null==(a=t[3])?void 0:a.toBuffer();if(a&&1===a[1])n={type:"at",qq:0,text:r},1===a[6]?(n.qq="all",this.atall=!0):(n.qq=a.readUInt32BE(7),n.qq===this.uin&&(this.atme=!0)),r=r||"@"+n.qq,i="{at:".concat(n.qq,"}");else{if(!r)return;n={type:"text",text:i=r}}break;case 2:n={type:"face",id:t[1],text:face_1.facemap[t[1]].text||"表情"},r="[".concat(n.text,"]"),i="{face:".concat(n.id,"}");break;case 33:n={type:"face",id:t[1],text:t[2]||"/"+t[1]},r="[".concat(n.text,"]"),i="{face:".concat(n.id,"}");break;case 6:i=(r=this.getNextText()).includes("骰子")||r.includes("猜拳")?(n={type:r.includes("骰子")?"dice":"rps",id:t[12].toBuffer()[16]-48+1},"{".concat(n.type,":").concat(n.id,"}")):(n={type:"bface",file:t[4].toHex()+t[7].toHex()+t[5],text:r.replace(/[[\]]/g,"")},"{bface:".concat(n.text,"}"));break;case 4:case 8:if(this.newImg)return;r=((n=this.parseImgElem(e,t,"image")).asface?"[动画表情]":"[图片]")+(n.summary||""),i="{image:".concat(n.md5.toUpperCase(),"}");break;case 31:if(103904510!==t[3])return;n={type:"mirai",data:String(t[2])};break;case 34:r=this.getNextText(),n={type:"sface",id:t[1],text:r.replace(/[[\]]/g,"")},i="{sface:".concat(n.id,"}");break;case 37:if(2!=t[6])return;var n={type:"long_msg",resid:null==(a=t[7])?void 0:a.toString()};break;case 45:n=_objectSpread({type:"markdown",content:null==(a=(t=t[2])[1])?void 0:a.toString()},t[2]?{config:{unknown:t[2][1]||1,time:t[2][2]||0,token:(null==(a=t[2][3])?void 0:a.toHex())||""}}:{}),i=r="[markdown消息]";break;case 46:t=t[2];try{var o=Array.isArray(t[1][1])?t[1][1]:[t[1][1]];n={type:"button",content:{appid:Number(t[1][2])||0,rows:o.map(function(e){var t,r=[],i=_createForOfIteratorHelper(e=Array.isArray(e[1])?e[1]:[e[1]]);try{for(i.s();!(t=i.n()).done;){var a,n,o,s,c,l=t.value,u={id:"",render_data:{},action:{permission:{}}};l[1]&&(u.id=null==(a=l[1])?void 0:a.toString()),l[2]&&(u.render_data.label=null==(n=l[2][1])?void 0:n.toString(),u.render_data.visited_label=null==(o=l[2][2])?void 0:o.toString(),u.render_data.style=Number(l[2][3])||0),l[3]&&(u.action.type=Number(l[3][1])||0,u.action.unsupport_tips=null==(s=l[3][4])?void 0:s.toString(),u.action.data=null==(c=l[3][5])?void 0:c.toString(),u.action.reply=1===l[3][7],u.action.enter=1===l[3][8],l[3][2])&&(u.action.permission.type=Number(l[3][2][1])||0,u.action.permission.specify_role_ids=l[3][2][2]||[],u.action.permission.specify_user_ids=l[3][2][3]||[]),r.push(u)}}catch(e){i.e(e)}finally{i.f()}return{buttons:r}})}},i=r="[button消息]"}catch(e){return}break;case 48:switch(t[3]){case 10:case 20:if(!(n=this.parseNewImgElem(t[2],"image")))return;r=(n.asface?"[动画表情]":"[图片]")+(n.summary||""),i="{image:".concat(n.md5.toUpperCase(),"}");break;case 11:case 21:var s=t[2][1],s=(s=Array.isArray(s)?s:[s]).find(function(e){return 100!==e[1][6]});n={type:"video",file:"protobuf://"+t[2].toBase64(),fid:s[1],md5:"ntvideo",size:0,seconds:0},r="视频",i="{video:".concat(n.file,"}");break;case 12:case 22:n={type:"record",file:t[2][1][1],url:"",md5:"ntptt",size:0,seconds:0},r="语音",i="{ptt:ntptt}";break;default:return}break;case 500:t=t[2],n={type:"forum",id:String(t[44][3]),create_time:Math.floor(t[44][5]/1e3)},r="[频道帖子]",i="{forum:".concat(n.id,"}");break;default:return}2===this.message.length&&"at"===n.type&&"at"===(null==(c=this.message[0])?void 0:c.type)&&"text"===(null==(c=this.message[1])?void 0:c.type)&&this.message[0].qq===n.qq&&" "===this.message[1].text&&(this.message.splice(0,2),this.brief=""),this.brief+=r,this.content+=i,Array.isArray(this.message)||(this.message=[]);var c=this.message[this.message.length-1];"text"===n.type&&"text"===(null==c?void 0:c.type)?c.text+=n.text:this.message.push(n)}},{key:"parseElems",value:function(e){for(this.it=e.entries();;){var t=null==(t=this.it.next().value)?void 0:t[1];if(!t)break;var r=Number(Object.keys(Reflect.getPrototypeOf(t))[0]),i=t[r];if(16===r)this.extra=i;else if(21===r)this.anon=i;else if(45===r)this.quotation=i;else if(!this.exclusive)switch(r){case 1:case 2:case 4:case 6:case 8:case 31:case 34:case 37:this.parsePartialElem(r,i);break;case 5:case 12:case 19:case 51:this.parseExclusiveElem(r,i);break;case 53:3===i[1]?this.parseExclusiveElem(3,i[2][1]||i[2][2]):33===i[1]?this.parsePartialElem(33,i[2]):2===i[1]?this.parseExclusiveElem(126,i):37===i[1]?this.parseExclusiveElem(37,i):20===i[1]?this.parseExclusiveElem(51,i[2]):[45,46,48,500].includes(i[1])&&this.parsePartialElem(i[1],i)}}}},{key:"parseNewImgElem",value:function(t,r){try{var e,i,a,n,o,s,c,l,u={type:r,file:null==(e=t[1][1][1][4])?void 0:e.toString(),url:"",file_id:null==(i=t[1][1][2])?void 0:i.toString(),md5:null==(a=t[1][1][1][2])?void 0:a.toString(),height:t[1][1][1][7],width:t[1][1][1][6],size:t[1][1][1][1],summary:null==(n=t[2][1])||null==(n=n[2])?void 0:n.toString()},p=("image"===r&&(u.asface=1===(null==(o=t[2][1])?void 0:o[1])),u.file=(0,image_1.buildImageFileParam)(u.md5,u.size,u.width,u.height,t[1][1][1][5][2]),((null==(s=(null==(c=t[2][1])?void 0:c[11])||(null==(l=t[2][1])?void 0:l[12]))?void 0:s[30])||"").toString());if(null!=p&&p.length)return this.newImg=!0,u.url="https://".concat(t[1][2][3]).concat(0===p.indexOf("/")?p:"".concat(t[1][2][1]).concat(p)).concat(t[1][2][2][1]||"&spec=0"),u;u.md5&&(u.url="https://".concat(t[1][2][3]).concat(t[1][2][1]),this.imgprefix[u.md5]=u)}catch(e){if("flash"===r)return this.parseImgElem(0,t,r)}}},{key:"parseImgElem",value:function(e,t,r){var i,e="flash"===r?!!t[1]:8!==e,a=t[e?7:13].toHex(),n=((null==(n=t[e?29:34])?void 0:n[30])||"").toString();return this.imgprefix[a]&&null!=n&&n.length?(i=null!=(i=this.imgprefix[a].url)&&i.length?new URL(this.imgprefix[a].url).origin:"",_objectSpread(_objectSpread({},this.imgprefix[a]),{},{type:r,url:"".concat((0===n.indexOf("/")?"".concat(i):"".concat(this.imgprefix[a].url)).concat(n),"&spec=0")})):((i={type:r,file:"",url:"",md5:a,height:t[e?8:23],width:t[e?9:22],size:t[e?2:25],summary:null==(i=t[e?29:34])||null==(i=i[e?8:9])?void 0:i.toString()}).file=(0,image_1.buildImageFileParam)(i.md5,i.size,i.width,i.height,t[e?5:20]),"image"===r&&(i.asface=1===(null==(r=t[e?29:34])?void 0:r[1])),i.url||(n?n.toString().includes("fileid")?i.url="https://c2cpicdw.qpic.cn".concat(n,"&spec=0"):i.url="https://c2cpicdw.qpic.cn".concat(t[16]):t[16]?i.url="https://gchat.qpic.cn".concat(t[16]):t[15]?i.url="https://c2cpicdw.qpic.cn".concat(t[15]):i.url=getGroupImageUrl(a)),i)}}]))();function getGroupImageUrl(e){return"https://gchat.qpic.cn/gchatpic_new/0/0-0-".concat(e.toUpperCase(),"/0")}exports.Parser=Parser;